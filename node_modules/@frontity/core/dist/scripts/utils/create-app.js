"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const create_server_1 = __importDefault(require("./create-server"));
// Create an express app ready to be used with webpack-dev-middleware.
exports.default = async ({ mode, port, isHttps, target }) => {
    // Create the app.
    const app = express_1.default();
    // Use the http or https modules to create the server.
    const server = await create_server_1.default({ app, isHttps });
    // Start listening once webpack has finished.
    let clientFinished = false;
    let serverFinished = false;
    const start = () => {
        if (clientFinished && serverFinished) {
            server.listen(port, () => {
                console.log(`\n\nSERVER STARTED -- Listening @ ${isHttps ? "https" : "http"}://localhost:${port}\n  - mode: ${mode}\n  - target: ${target}`);
            });
        }
    };
    // Check if webpack has finished (both the client and server bundles).
    const done = (compiler) => {
        compiler.compilers[0].hooks.done.tapAsync("frontity-dev-server", (_, cb) => {
            clientFinished = true;
            start();
            cb();
        });
        compiler.compilers[1].hooks.done.tapAsync("frontity-dev-server", (_, cb) => {
            serverFinished = true;
            start();
            cb();
        });
    };
    return { app, done };
};
